@model OrderManagementApp.ViewModels.OrderViewModel

@{
    ViewData["Title"] = "Главная страница";
}

<div class="container">
    <div class="card">
        <h2 class="mb-4">Список товаров</h2>
        <div class="products-list">
            @foreach (var product in Model.Products)
            {
                <div class="product-item" onclick="addToOrder(@product.Id)">
                    <h5>@product.Name</h5>
                    <p class="mb-0">@product.Price.ToString("C")</p>
                </div>
            }
        </div>
    </div>

    <div class="card">
        <h2 class="mb-4">Форма заказа</h2>
        <table class="order-table table table-striped">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">№</th>
                    <th scope="col">Наименование товара</th>
                    <th scope="col">Цена</th>
                    <th scope="col">Количество</th>
                    <th scope="col">Сумма</th>
                    <th scope="col">Удалить</th>
                </tr>
            </thead>
            <tbody id="order-items">
                @for (int i = 0; i < Model.Order.Items.Count; i++)
                {
                    var item = Model.Order.Items[i];
                    <tr>
                        <td>@(i + 1)</td>
                        <td>@item.ProductName</td>
                        <td class="price-cell">@item.Price.ToString("C")</td>
                        <td><input type="number" min="1" max="1000" value="@item.Quantity" class="form-control quantity-input" onchange="updateQuantity(@item.ProductId, this.value)" style="width: 100px;" /></td>
                        <td class="total-price-cell">@item.GetTotalPrice().ToString("C")</td>
                        <td><button class="btn btn-danger btn-sm" onclick="removeFromOrder(@item.ProductId)">Удалить</button></td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="total-amount mt-3">
            <h3>Общая сумма заказа: <span id="total">@Model.Order.GetTotalAmount().ToString("C")</span></h3>
        </div>

        <div class="mt-3">
            <button class="btn btn-warning" onclick="clearOrder()">Очистить заказ</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        async function addToOrder(productId) {
            try {
                const response = await fetch('/Home/AddToOrder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `productId=${productId}`
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('total').textContent = result.totalAmount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' });
                    location.reload(); // Перезагружаем страницу для обновления заказа
                } else {
                    const errorText = await response.text();
                    alert(`Ошибка при добавлении товара: ${errorText}`);
                }
            } catch (error) {
                console.error('Ошибка при добавлении товара:', error);
                alert('Произошла ошибка при добавлении товара');
            }
        }

        async function updateQuantity(productId, quantity) {
            try {
                const response = await fetch('/Home/UpdateQuantity', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `productId=${productId}&quantity=${quantity}`
                });

                if (response.ok) {
                    const result = await response.json();
                    document.getElementById('total').textContent = result.totalAmount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' });

                    // Обновляем сумму для конкретного элемента
                    const row = event.target.closest('tr');
                    const priceCell = row.querySelector('.price-cell');
                    const priceText = priceCell.textContent.trim();

                    // Извлекаем числовое значение цены из строки формата валюты
                    const priceValue = parseFloat(priceText.replace(/[^\d,-]/g, '').replace(',', '.'));
                    const newTotal = priceValue * parseInt(quantity);

                    const totalCell = row.querySelector('.total-price-cell');
                    totalCell.textContent = newTotal.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' });
                } else {
                    const errorText = await response.text();
                    alert(`Ошибка при обновлении количества: ${errorText}`);
                }
            } catch (error) {
                console.error('Ошибка при обновлении количества:', error);
                alert('Произошла ошибка при обновлении количества');
            }
        }

        async function removeFromOrder(productId) {
            try {
                const response = await fetch('/Home/RemoveFromOrder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `productId=${productId}`
                });

                if (response.ok) {
                    const result = await response.json();
                    // Удаляем строку из таблицы
                    event.target.closest('tr').remove();
                    // Обновляем номера строк
                    updateRowNumbers();
                    // Обновляем общую сумму
                    document.getElementById('total').textContent = result.totalAmount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' });
                } else {
                    const errorText = await response.text();
                    alert(`Ошибка при удалении товара: ${errorText}`);
                }
            } catch (error) {
                console.error('Ошибка при удалении товара:', error);
                alert('Произошла ошибка при удалении товара');
            }
        }

        async function clearOrder() {
            if (confirm('Вы уверены, что хотите очистить весь заказ?')) {
                try {
                    const response = await fetch('/Home/ClearOrder', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        // Очищаем таблицу заказов
                        const orderItems = document.getElementById('order-items');
                        orderItems.innerHTML = '';
                        // Обновляем общую сумму
                        document.getElementById('total').textContent = result.totalAmount.toLocaleString('ru-RU', { style: 'currency', currency: 'RUB' });
                    } else {
                        const errorText = await response.text();
                        alert(`Ошибка при очистке заказа: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Ошибка при очистке заказа:', error);
                    alert('Произошла ошибка при очистке заказа');
                }
            }
        }

        function updateRowNumbers() {
            const rows = document.querySelectorAll('#order-items tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        }
    </script>
}